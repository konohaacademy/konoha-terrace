<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>コノハ・テラス</title>
    <!-- CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans JP', sans-serif; -webkit-tap-highlight-color: transparent; }
        .safe-area-pb { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="bg-stone-50">
    <div id="root"></div>

    <!-- Core Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase (Compatibility Version for easier setup) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Firebase Configuration ---
        // 環境変数がない場合でもエラーにならないように空オブジェクトをデフォルトに設定
        let config = {};
        try {
            config = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        } catch (e) {
            console.warn("Firebase config not found, using demo mode.");
        }

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'konoha-terrace-v1';

        // Initialize Firebase only if config exists
        if (config.apiKey) {
            firebase.initializeApp(config);
        }

        const Icons = {
            Leaf: ({ size = 24 }) => (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 20A7 7 0 0 1 9.8 6.1C15.5 5 17 4.48 19 2c1 2 2 3.5 1 9.8a7 7 0 0 1-9 8.2Zm0 0v-5m-4.5-1.5L11 15"/></svg>
            ),
            BookOpen: ({ size = 24 }) => (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
            ),
            User: ({ size = 24 }) => (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
            ),
            Plus: ({ size = 24 }) => (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 5v14M5 12h14"/></svg>
            )
        };

        const AnimalIllustration = ({ seed = 0 }) => {
            const animalIds = ["1E_9xwSVHPNgwzDNeawLPaJcr80KlRkpX", "128gqAbo-7tZ3Tx6lMMv803s-Qr7ugyfX", "1jx2MvGVvq6NiJ_qj_D6coutb05i7ERGZ"];
            const id = animalIds[seed % animalIds.length];
            return (
                <div className="w-full h-full rounded-full bg-stone-100 flex items-center justify-center overflow-hidden border border-stone-200">
                    <img src={`https://drive.google.com/uc?export=view&id=${id}`} alt="icon" className="w-full h-full object-cover" />
                </div>
            );
        };

        function App() {
            const [view, setView] = useState('feed');
            const [user, setUser] = useState(null);
            const [posts, setPosts] = useState([
                { id: 1, userName: "サンプル住人", caption: "今日は数学を2時間頑張りました。", studySeconds: 7200, animalSeed: 0, imageUrl: "https://images.unsplash.com/photo-1456513080510-7bf3a84b82f8?w=800" }
            ]);

            useEffect(() => {
                if (!config.apiKey) return;
                const unsub = firebase.auth().onAuthStateChanged(u => {
                    setUser(u);
                    if (u) {
                        // データ取得ロジック (簡略化)
                        const db = firebase.firestore();
                        db.collection('artifacts').doc(appId).collection('public').doc('data').collection('posts')
                            .orderBy('createdAt', 'desc').limit(20).onSnapshot(s => {
                                if (!s.empty) setPosts(s.docs.map(d => ({ id: d.id, ...d.data() })));
                            });
                    }
                });
                return () => unsub();
            }, []);

            const handleLogin = () => {
                if (!config.apiKey) {
                    // デモ用ログイン
                    setUser({ uid: 'demo', displayName: 'ゲストユーザー' });
                    return;
                }
                const provider = new firebase.auth.GoogleAuthProvider();
                firebase.auth().signInWithPopup(provider);
            };

            return (
                <div className="flex flex-col h-screen max-w-md mx-auto bg-stone-50 shadow-2xl overflow-hidden border-x border-stone-200 relative">
                    {/* Header */}
                    <header className="px-6 py-4 bg-white/80 backdrop-blur-md border-b border-stone-100 flex justify-between items-center sticky top-0 z-50">
                        <div className="flex items-center gap-2">
                            <div className="w-8 h-8 bg-emerald-900 rounded-lg flex items-center justify-center text-white"><Icons.Leaf size={16} /></div>
                            <h1 className="text-sm font-black text-emerald-950 uppercase tracking-tighter">Konoha Terrace</h1>
                        </div>
                    </header>

                    {/* Main Content */}
                    <main className="flex-1 overflow-y-auto pb-24">
                        {!user ? (
                            <div className="p-10 text-center h-full flex flex-col justify-center">
                                <h2 className="text-2xl font-black text-stone-800 mb-4">秘密の庭へようこそ</h2>
                                <p className="text-sm text-stone-500 mb-8 leading-relaxed">学習の記録をシェアして、<br/>自分だけの図鑑を育てましょう。</p>
                                <button onClick={handleLogin} className="bg-emerald-900 text-white py-4 px-8 rounded-full font-bold shadow-lg active:scale-95 transition-transform">Googleでログイン</button>
                            </div>
                        ) : (
                            <div className="p-4 space-y-4">
                                {view === 'feed' && posts.map(p => (
                                    <div key={p.id} className="bg-white rounded-[2rem] border border-stone-100 overflow-hidden shadow-sm">
                                        <div className="p-4 flex items-center gap-3">
                                            <div className="w-8 h-8"><AnimalIllustration seed={p.animalSeed} /></div>
                                            <div className="text-xs font-bold text-stone-700">{p.userName}</div>
                                        </div>
                                        <img src={p.imageUrl} className="w-full aspect-[4/3] object-cover" />
                                        <div className="p-4">
                                            <p className="text-sm text-stone-600">{p.caption}</p>
                                        </div>
                                    </div>
                                ))}
                                {view === 'profile' && (
                                    <div className="py-10 text-center">
                                        <div className="w-24 h-24 mx-auto mb-4"><AnimalIllustration seed={2} /></div>
                                        <h2 className="font-black text-xl">{user.displayName}</h2>
                                        <p className="text-stone-400 text-sm mt-2">学習時間: 12時間30分</p>
                                    </div>
                                )}
                            </div>
                        )}
                    </main>

                    {/* Navigation */}
                    {user && (
                        <nav className="absolute bottom-0 left-0 right-0 bg-white/90 backdrop-blur-lg border-t border-stone-100 px-8 py-4 flex justify-between items-center safe-area-pb">
                            <button onClick={() => setView('feed')} className={view === 'feed' ? 'text-emerald-900' : 'text-stone-300'}><Icons.BookOpen size={24}/></button>
                            <button className="w-12 h-12 bg-emerald-950 rounded-full flex items-center justify-center text-white shadow-lg"><Icons.Plus size={24}/></button>
                            <button onClick={() => setView('profile')} className={view === 'profile' ? 'text-emerald-900' : 'text-stone-300'}><Icons.User size={24}/></button>
                        </nav>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>