<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>コノハ・テラス - 秘密の庭の図鑑</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans JP', sans-serif; -webkit-tap-highlight-color: transparent; }
        .scale-in { animation: scaleIn 0.2s ease-out; }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-stone-50 text-stone-900">
    <div id="root"></div>

    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase SDK (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Firebase設定（変更なし）
        const firebaseConfig = {
            apiKey: "AIzaSyCw4_fqIsqX7pokH8eG8pOBJmQx2oVI5B8",
            authDomain: "konoha-terrace.firebaseapp.com",
            projectId: "konoha-terrace",
            storageBucket: "konoha-terrace.firebasestorage.app",
            messagingSenderId: "250486346479",
            appId: "1:250486346479:web:d0ea932f11de1e78ac011a",
            measurementId: "G-B4YXDXHZ17"
        };

        let auth, db, provider;
        const appId = "konoha-terrace-v12";

        const initializeFirebase = () => {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            auth = firebase.auth();
            db = firebase.firestore();
            provider = new firebase.auth.GoogleAuthProvider();
        };

        // --- アイコンコンポーネント ---
        const Icons = {
            Leaf: ({ size = 24, fill = "none" }) => (
                <svg width={size} height={size} viewBox="0 0 24 24" fill={fill} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 20A7 7 0 0 1 9.8 6.1C15.5 5 17 4.48 19 2c1 2 2 3.5 1 9.8a7 7 0 0 1-9 8.2Zm0 0v-5m-4.5-1.5L11 15"/></svg>
            ),
            BookOpen: ({ size = 24 }) => (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
            ),
            Trophy: ({ size = 24 }) => (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>
            ),
            User: ({ size = 24 }) => (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
            ),
            Plus: ({ size = 24 }) => (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 5v14M5 12h14"/></svg>
            ),
            Settings: ({ size = 24 }) => (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2a2 2 0 0 1-2 2a2 2 0 0 0-2 2a2 2 0 0 1-2 2a2 2 0 0 0-2 2v.44a2 2 0 0 0 2 2a2 2 0 0 1 2 2a2 2 0 0 0 2 2a2 2 0 0 1 2 2a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2a2 2 0 0 1 2-2a2 2 0 0 0 2-2a2 2 0 0 1 2-2a2 2 0 0 0 2-2v-.44a2 2 0 0 0-2-2a2 2 0 0 1-2-2a2 2 0 0 0-2-2a2 2 0 0 1-2-2a2 2 0 0 0-2-2Z"/><circle cx="12" cy="12" r="3"/></svg>
            ),
            Send: ({ size = 20 }) => (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
            ),
            Camera: ({ size = 24 }) => (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
            ),
            Flower: ({ size = 24 }) => (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"/><path d="M12 2v3m0 14v3M2 12h3m14 0h3M5.6 5.6l2.1 2.1m8.6 8.6l2.1 2.1M5.6 18.4l2.1-2.1m8.6-8.6l2.1-2.1"/></svg>
            ),
            Bird: ({ size = 24 }) => (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 7a4 4 0 0 1-8 0"/><path d="M12 11v6"/><path d="M12 17H8m4 0h4"/></svg>
            ),
            X: ({ size = 24 }) => (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            )
        };

        // --- 動物アバターコンポーネント ---
        const AnimalIllustration = ({ seed = 0 }) => {
            const animalIds = [
                "1E_9xwSVHPNgwzDNeawLPaJcr80KlRkpX", "128gqAbo-7tZ3Tx6lMMv803s-Qr7ugyfX", "1jx2MvGVvq6NiJ_qj_D6coutb05i7ERGZ", "17ZN2OCXJvkt76zY0DiG68hmZ7EGJfmRZ", "1pd3ohU5IIPBZ66B_-HcwidKr1KGk_sTe",
                "16X7JFcv4azrLOBggA5AEYt52XHjNj2ay", "1OggJov_8i-X_fX4dKUjSSBttoOB1g_aM", "1jjf-I-7f_5f9MV7TsdJV_UO7VMbvgN0t", "1ECKCdQ-crBMnbjatwj9k063rDnfppaxD", "1DQubZfMpKW9AdDOC_0ml4bd4LHi839XT",
                "169y9xhwOWhvK1kfVXOMriC45vcvi_imc", "1NGw-VtPHbKdP1PmkgLPAx-fhCvJN0jQT", "1Mk-Nx1UmHg5YxLLGSX2TadwlcRgdSXCH", "1Va_mONQkmMnxYZOwN_twb-PveL4jS8JQ", "1gTHuLPyknlJ-FLQkH8EdKD5iplaMiQux",
                "1xXdOiV7SWIOppcwZ3tIaQFMMWMIjnQTj", "17o6c2pCOWwNvJ2iEd6NG1F_kn2UECvBS", "1aCTvREdWDHz9vaRyFCAWsQnp8Ucb0Qth", "1GoBUY4Ks_Xr5Xt7_ciQIxjpkmufxhyYr", "1NWj4s03xS10dCy-4Ar_77r902zR5HAPY"
            ];
            const id = animalIds[seed % animalIds.length];
            return (
                <div className="w-full h-full rounded-full bg-white flex items-center justify-center overflow-hidden border border-stone-100 shadow-inner relative">
                    <img src={`https://drive.google.com/uc?export=view&id=${id}`} alt="Animal" className="w-full h-full object-cover scale-110" />
                </div>
            );
        };

        function App() {
            const [user, setUser] = useState(null);
            const [profile, setProfile] = useState(null);
            const [view, setView] = useState('feed');
            const [loading, setLoading] = useState(true);
            const [posts, setPosts] = useState([]);
            const [profiles, setProfiles] = useState([]);
            const [timerSeconds, setTimerSeconds] = useState(0);
            const [isTimerRunning, setIsTimerRunning] = useState(false);
            const [caption, setCaption] = useState('');
            const [selectedImage, setSelectedImage] = useState(null);
            const [isEditingName, setIsEditingName] = useState(false);
            const [newName, setNewName] = useState('');
            const [authError, setAuthError] = useState(null);
            const timerRef = useRef(null);
            const fileInputRef = useRef(null);

            useEffect(() => {
                initializeFirebase();
                const unsub = auth.onAuthStateChanged(async (u) => {
                    setUser(u);
                    if (u) {
                        const pRef = db.collection('artifacts').doc(appId).collection('users').doc(u.uid).collection('profile').doc('data');
                        const snap = await pRef.get();
                        if (snap.exists) {
                            setProfile(snap.data());
                        } else {
                            const initial = { 
                                uid: u.uid, 
                                displayName: u.displayName || '庭の住人', 
                                totalSeconds: 0, 
                                postCount: 0, 
                                animalSeed: Math.floor(Math.random() * 20) 
                            };
                            await pRef.set(initial);
                            await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('profiles').doc(u.uid).set(initial);
                            setProfile(initial);
                        }
                    }
                    setLoading(false);
                });
                return () => unsub();
            }, []);

            useEffect(() => {
                if (!user) return;
                const unsubPosts = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('posts')
                    .orderBy('createdAt', 'desc').limit(20).onSnapshot(s => {
                        setPosts(s.docs.map(d => ({ id: d.id, ...d.data() })));
                    });
                const unsubProfiles = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('profiles')
                    .onSnapshot(s => {
                        setProfiles(s.docs.map(d => d.data()).sort((a, b) => (b.totalSeconds || 0) - (a.totalSeconds || 0)));
                    });
                return () => { unsubPosts(); unsubProfiles(); };
            }, [user]);

            const handleLogin = async () => {
                setAuthError(null);
                try {
                    await auth.signInWithPopup(provider);
                } catch (err) {
                    if (err.code === 'auth/operation-not-allowed') {
                        setAuthError("Googleログインが有効になっていません。Firebase Consoleを確認してください。");
                    } else {
                        setAuthError("エラーが発生しました: " + err.message);
                    }
                }
            };

            const formatTime = (s) => {
                const h = Math.floor(s / 3600);
                const m = Math.floor((s % 3600) / 60);
                const sc = s % 60;
                return `${h > 0 ? h + '時間 ' : ''}${m}分 ${sc}秒`;
            };

            const handleImageSelect = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => setSelectedImage(event.target.result);
                    reader.readAsDataURL(file);
                }
            };

            const handlePost = async () => {
                if (!caption.trim() || !profile) return;
                const postData = {
                    userId: user.uid, userName: profile.displayName, animalSeed: profile.animalSeed,
                    caption, studySeconds: timerSeconds, 
                    imageUrl: selectedImage || "https://images.unsplash.com/photo-1456513080510-7bf3a84b82f8?w=800",
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('posts').add(postData);
                const up = { 
                    totalSeconds: firebase.firestore.FieldValue.increment(timerSeconds), 
                    postCount: firebase.firestore.FieldValue.increment(1) 
                };
                await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('profile').doc('data').update(up);
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('profiles').doc(user.uid).update(up);
                
                // Stateリセット
                setCaption(''); setTimerSeconds(0); setIsTimerRunning(false); setSelectedImage(null);
                if (timerRef.current) clearInterval(timerRef.current);
                setView('feed');
            };

            if (loading) return <div className="h-screen flex items-center justify-center bg-stone-50"><div className="w-8 h-8 border-4 border-emerald-900 border-t-transparent rounded-full animate-spin"></div></div>;

            if (!user) return (
                <div className="h-screen flex flex-col items-center justify-center bg-stone-50 p-6 text-center">
                    <div className="w-20 h-20 bg-emerald-900 rounded-3xl flex items-center justify-center text-white mb-6 shadow-xl scale-in">
                        <Icons.Leaf size={40} fill="currentColor" />
                    </div>
                    <h1 className="text-2xl font-black text-emerald-950 mb-2">コノハ・テラス</h1>
                    <p className="text-stone-400 text-sm mb-8">静かな場所で、共に学ぶ。</p>
                    {authError && <div className="mb-6 p-4 bg-rose-50 border border-rose-100 rounded-2xl text-rose-600 text-xs font-bold">{authError}</div>}
                    <button onClick={handleLogin} className="flex items-center gap-3 bg-white border border-stone-200 px-8 py-4 rounded-full shadow-sm font-bold text-stone-700 active:scale-95 hover:bg-stone-50 transition-all">
                        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" className="w-5 h-5" />
                        Googleアカウントで始める
                    </button>
                </div>
            );

            return (
                <div className="flex flex-col h-screen max-w-md mx-auto bg-stone-50 shadow-2xl overflow-hidden border-x border-stone-200 text-stone-900 relative">
                    <header className="px-6 py-4 bg-white/80 backdrop-blur-md border-b border-stone-100 flex justify-between items-center sticky top-0 z-50">
                        <div className="flex items-center gap-2 cursor-pointer" onClick={() => setView('feed')}>
                            <div className="w-8 h-8 bg-emerald-900 rounded-lg flex items-center justify-center text-white"><Icons.Leaf size={16} fill="currentColor" /></div>
                            <h1 className="text-sm font-black text-emerald-950 uppercase tracking-tighter">Konoha Terrace</h1>
                        </div>
                    </header>

                    <main className="flex-1 overflow-y-auto pb-32">
                        {view === 'feed' && (
                            <div className="p-4 space-y-5">
                                {posts.length === 0 ? (
                                    <div className="text-center py-20 text-stone-300 font-bold">まだ投稿がありません</div>
                                ) : posts.map(p => (
                                    <div key={p.id} className="bg-white rounded-[2rem] border border-stone-100 overflow-hidden shadow-sm scale-in">
                                        <div className="p-4 flex items-center gap-3">
                                            <div className="w-10 h-10"><AnimalIllustration seed={p.animalSeed} /></div>
                                            <div className="text-xs font-black text-stone-800">{p.userName}</div>
                                        </div>
                                        <img src={p.imageUrl} className="w-full aspect-[4/3] object-cover" />
                                        <div className="p-5">
                                            <div className="bg-emerald-50 inline-block px-3 py-1 rounded-lg text-[10px] font-black text-emerald-900 mb-3 border border-emerald-100">
                                                ⏱ {formatTime(p.studySeconds)}
                                            </div>
                                            <p className="text-[13px] text-stone-600 font-medium leading-relaxed">{p.caption}</p>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {view === 'ranking' && (
                            <div className="p-6 space-y-4 scale-in">
                                <h2 className="text-lg font-black text-stone-800 mb-6 flex items-center gap-2"><Icons.Trophy /> 学習ランキング</h2>
                                {profiles.map((p, i) => (
                                    <div key={p.uid} className="flex items-center gap-4 bg-white p-4 rounded-2xl border border-stone-100 shadow-sm">
                                        <div className={`w-6 h-6 rounded-full flex items-center justify-center text-[10px] font-black ${i < 3 ? 'bg-amber-400 text-white' : 'bg-stone-100 text-stone-400'}`}>{i + 1}</div>
                                        <div className="w-14 h-14"><AnimalIllustration seed={p.animalSeed} /></div>
                                        <div className="flex-1">
                                            <p className="text-xs font-black text-stone-800">{p.displayName}</p>
                                            <p className="text-[10px] font-bold text-stone-400 mt-0.5">{formatTime(p.totalSeconds || 0)}</p>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {view === 'post' && (
                            <div className="p-6 space-y-6 scale-in">
                                <div className="bg-emerald-950 p-10 rounded-[2.5rem] text-center shadow-xl border-4 border-white">
                                    <p className="text-emerald-300 text-[10px] font-black uppercase tracking-widest mb-2">Focusing Now</p>
                                    <h3 className="text-5xl font-mono font-black text-white mb-8 tracking-tighter">
                                        {Math.floor(timerSeconds/60).toString().padStart(2,'0')}:{(timerSeconds%60).toString().padStart(2,'0')}
                                    </h3>
                                    <button onClick={() => {
                                        if (isTimerRunning) { clearInterval(timerRef.current); } 
                                        else { timerRef.current = setInterval(() => setTimerSeconds(s => s + 1), 1000); }
                                        setIsTimerRunning(!isTimerRunning);
                                    }} className={`w-full py-5 rounded-2xl font-black text-white ${isTimerRunning ? 'bg-rose-500' : 'bg-emerald-600'} transition-all active:scale-95 shadow-lg`}>
                                        {isTimerRunning ? '学習を一時停止' : '学習を記録'}
                                    </button>
                                </div>

                                <div className="space-y-4">
                                    <button onClick={() => fileInputRef.current?.click()} className="w-full flex flex-col items-center justify-center gap-2 p-8 bg-white border-2 border-dashed border-stone-200 rounded-3xl text-stone-400 hover:border-emerald-500 transition-all">
                                        {selectedImage ? <img src={selectedImage} className="w-full h-32 object-cover rounded-xl" /> : <><Icons.Camera size={32}/><span className="text-[10px] font-black uppercase">写真を投稿</span></>}
                                    </button>
                                    <input type="file" ref={fileInputRef} onChange={handleImageSelect} accept="image/*" className="hidden" />
                                    
                                    <textarea value={caption} onChange={e => setCaption(e.target.value)} placeholder="今日の内容や気づきをメモ..." className="w-full p-5 bg-white border border-stone-200 rounded-[1.5rem] outline-none text-sm min-h-[120px] shadow-inner focus:border-emerald-500" />
                                </div>

                                <button onClick={handlePost} className="w-full py-5 bg-emerald-900 text-white rounded-full font-black shadow-xl flex items-center justify-center gap-2 active:scale-95 transition-all"><Icons.Send /> 庭に報告する</button>
                            </div>
                        )}

                        {view === 'profile' && profile && (
                            <div className="p-6 space-y-6 scale-in">
                                <div className="bg-white rounded-[2.5rem] p-8 border border-stone-100 shadow-xl text-center">
                                    <div className="w-32 h-32 mx-auto mb-6"><AnimalIllustration seed={profile.animalSeed} /></div>
                                    <div className="flex items-center justify-center gap-2 mb-6">
                                        <h2 className="text-2xl font-black text-stone-800">{profile.displayName}</h2>
                                        <button onClick={() => { setNewName(profile.displayName); setIsEditingName(true); }} className="p-1 text-stone-300 hover:text-emerald-900 transition-colors"><Icons.Plus size={16}/></button>
                                    </div>

                                    <div className="bg-stone-50 rounded-2xl p-4 mb-6">
                                        <div className="flex justify-center gap-4 mb-4">
                                            <div className={`p-3 rounded-full border ${profile.postCount >= 1 ? 'bg-emerald-100 border-emerald-200 text-emerald-600' : 'bg-stone-100 border-stone-200 text-stone-300 opacity-50'}`}><Icons.Leaf size={20}/></div>
                                            <div className={`p-3 rounded-full border ${profile.totalSeconds >= 3600 ? 'bg-amber-100 border-amber-200 text-amber-600' : 'bg-stone-100 border-stone-200 text-stone-300 opacity-50'}`}><Icons.Bird size={20}/></div>
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-2 gap-4">
                                        <div className="bg-stone-50 p-4 rounded-2xl text-left border border-stone-100">
                                            <p className="text-[9px] font-black text-stone-400 mb-1 uppercase tracking-widest">Time</p>
                                            <p className="text-sm font-black text-emerald-900 leading-tight">{formatTime(profile.totalSeconds)}</p>
                                        </div>
                                        <div className="bg-stone-50 p-4 rounded-2xl text-left border border-stone-100">
                                            <p className="text-[9px] font-black text-stone-400 mb-1 uppercase tracking-widest">Posts</p>
                                            <p className="text-sm font-black text-emerald-900 leading-tight">{profile.postCount}回</p>
                                        </div>
                                    </div>
                                    
                                    <button onClick={() => setView('settings')} className="mt-8 w-full py-4 bg-stone-50 rounded-2xl text-[11px] font-black text-stone-500 flex items-center justify-center gap-2 hover:bg-white transition-all">
                                        <Icons.Settings size={16} /> アイコンを着替える
                                    </button>
                                </div>
                                <button onClick={() => auth.signOut()} className="w-full text-[10px] font-black text-stone-300 mt-4 uppercase tracking-widest text-center">Logout</button>
                            </div>
                        )}

                        {view === 'settings' && (
                            <div className="p-6 scale-in">
                                <h2 className="text-lg font-black text-stone-800 mb-6">アバターを選択</h2>
                                <div className="grid grid-cols-4 gap-4">
                                    {Array.from({ length: 20 }).map((_, i) => (
                                        <button key={i} onClick={async () => {
                                            const up = { animalSeed: i };
                                            await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('profile').doc('data').update(up);
                                            await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('profiles').doc(user.uid).update(up);
                                            setProfile({...profile, animalSeed: i});
                                            setView('profile');
                                        }} className={`p-1 rounded-2xl border-2 transition-all ${profile.animalSeed === i ? 'border-emerald-500 bg-emerald-50' : 'border-stone-100'}`}>
                                            <AnimalIllustration seed={i} />
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}
                    </main>

                    {isEditingName && (
                        <div className="fixed inset-0 bg-stone-900/60 backdrop-blur-sm z-[100] flex items-center justify-center p-6">
                            <div className="bg-white w-full max-w-xs rounded-[2rem] p-8 shadow-2xl scale-in">
                                <h3 className="text-lg font-black text-stone-800 mb-6 text-center">名前の変更</h3>
                                <input type="text" value={newName} onChange={e => setNewName(e.target.value)} className="w-full p-4 bg-stone-50 border border-stone-200 rounded-2xl outline-none focus:border-emerald-500 transition-all font-bold mb-6" autoFocus />
                                <button onClick={async () => {
                                    if (!newName.trim()) return;
                                    const up = { displayName: newName };
                                    await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('profile').doc('data').update(up);
                                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('profiles').doc(user.uid).update(up);
                                    setProfile({...profile, displayName: newName});
                                    setIsEditingName(false);
                                }} className="w-full py-4 bg-emerald-900 text-white rounded-full font-black shadow-lg">保存する</button>
                            </div>
                        </div>
                    )}

                    <nav className="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white/95 backdrop-blur-md border-t border-stone-100 px-6 py-4 flex justify-between items-center rounded-t-[2.5rem] shadow-lg">
                        <button onClick={() => setView('feed')} className={`p-2 ${view === 'feed' ? 'text-emerald-900' : 'text-stone-300'}`}><Icons.BookOpen size={26}/></button>
                        <button onClick={() => setView('ranking')} className={`p-2 ${view === 'ranking' ? 'text-emerald-900' : 'text-stone-300'}`}><Icons.Trophy size={26}/></button>
                        <button onClick={() => setView('post')} className="w-14 h-14 bg-emerald-950 rounded-full flex items-center justify-center text-white -mt-12 border-4 border-stone-50 shadow-2xl active:scale-90 transition-all"><Icons.Plus size={30}/></button>
                        <button onClick={() => setView('profile')} className={`p-2 ${view === 'profile' || view === 'settings' ? 'text-emerald-900' : 'text-stone-300'}`}><Icons.User size={26}/></button>
                    </nav>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>